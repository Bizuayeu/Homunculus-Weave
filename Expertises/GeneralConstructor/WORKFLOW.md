# General Constructor - AI側ワークフロー

本ドキュメントはAI（Weave）が目論見作成時に実行する詳細ワークフローを定義します。

## 目次

- [Phase 0: ワークフロー初期化](#phase-0-ワークフロー初期化)
- [Phase 1: 初期準備とデータ収集](#phase-1-初期準備とデータ収集)
- [Phase 2: 地盤分析](#phase-2-地盤分析柱状図がある場合のみ)
- [Phase 3: データ抽出と確認](#phase-3-データ抽出と確認)
- [Phase 4: 計算実行](#phase-4-計算実行) ← **4.3 バリデーション必須**
- [Phase 5: 結果提示](#phase-5-結果提示)
- [Phase 6: 修正対応](#phase-6-修正対応)
- [Reference Files](#reference-files)
- [法規制確認（Web検索）](#法規制確認web検索)

## Phase 0: ワークフロー初期化

### 0.1 ToDoList作成

**ワークフロー開始時に必ずToDoListを作成し、ユーザーに表示する。**

バリデーションステップの見落としを防ぐため、以下のチェックリストを明示：

```
【目論見作成 ToDoList】
□ Phase 1: 初期準備とデータ収集
  □ 1.1 ビジネスルール確認
  □ 1.2 データアップロード依頼
□ Phase 2: 地盤分析（柱状図がある場合）
  □ 2.1 地盤評価判定
  □ 2.2 基礎種別決定
  □ 2.3 必要土質試験の特定
  □ 2.4 判定結果の提示
□ Phase 3: データ抽出と確認
  □ 3.1 マイソクからのデータ抽出
  □ 3.2 AI判断による補完
  □ 3.3 データ確認依頼
  □ 3.4 不足データの補完
□ Phase 4: 計算実行
  □ 4.1 Python計算モジュール呼び出し
  □ 4.2 計算結果の取得
  □ 4.3 計算結果のバリデーション
□ Phase 5: 結果提示
  □ 5.1 クイックサマリー
  □ 5.2 詳細目論見書
  □ 5.3 懸念点の共有
□ Phase 6: 修正対応（必要に応じて）
```

### 0.2 ToDoList運用ルール

- 各Phaseの開始時に「□」を「■」に更新
- バリデーション（4.3）は**必ず実行**し、スキップ不可
- 問題発見時は該当Phaseに戻って修正

## Phase 1: 初期準備とデータ収集

### 1.1 ビジネスルール確認

内部的に以下を読み込み、構造を把握：

- `References/ビジネスルール一覧.json` - データ項目と計算ロジック
- 各種単価テーブル（建築・基礎・山留・解体・貸床）

### 1.2 データアップロード依頼

ユーザーに依頼：

```
マイソク（不動産物件情報）をアップロードしてください。
近隣柱状図（ボーリングデータ）がある場合は、併せてアップロードいただくと、
地盤評価と基礎設計の精緻な判定が可能です。
```

## Phase 2: 地盤分析（柱状図がある場合のみ）

近隣柱状図がアップロードされた場合、3段階の判定を実行：

### 2.1 地盤評価判定

```
Input:  N値分布データ
Logic:  References/地盤評価詳細判定ロジック.json
Output: 硬質地盤 / 中間地盤① / 中間地盤② / 軟弱地盤
```

- N値分布から終端支持層・中間支持層を特定
- 地盤の支持力特性を評価

### 2.2 基礎種別決定

```
Input:  地盤評価結果 + 建物階数
Logic:  References/基礎種別テーブル.json
Output: 刃ベタ基礎 / 礎ベタ基礎 / 20m杭基礎 / 30m杭基礎 / 40m杭基礎
```

- 地盤条件と建物規模から最適な基礎形式を選択

### 2.3 必要土質試験の特定

```
Input:  地盤特性データ
Logic:  References/土質試験内容判定ロジック.json
Output: 必要試験リスト（三軸UU / 圧密 / LLT / 液状化判定 / 一軸圧縮 等）
```

- 地盤リスクに応じた追加調査項目を提示

### 2.4 判定結果の提示

3つの判定結果をユーザーに提示し、確認を得る：

```
【地盤分析結果】
- 地盤評価: 中間地盤
- 基礎種別: 礎ベタ基礎
- 必要土質試験: 三軸UU試験、圧密試験

上記の判定結果で見積を進めてよろしいですか？
```

## Phase 3: データ抽出と確認

### 3.1 マイソクからのデータ抽出

`ビジネスルール一覧.json`の「取得方針: 入力」項目について、マイソクから自動取得：

**基本情報**:
- 土地価格、土地所在、有効宅地面積

**施工条件**:
- 前面道路幅員、搬入経路、道路種別、接道長さ

**解体**:
- 古家構造、解体面積

**設計条件**:
- 実効建蔽率、用途地域、高度地区、最大容積率

### 3.2 AI判断による補完

以下の項目はAIが判断（またはデフォルト値を使用）：

| 項目 | 判断ロジック |
|------|-------------|
| 住宅種別 | 接道長さ < 4m → 長屋 / else → 共同住宅 |
| 建物層数 | 長屋 → 3層 / 共同住宅 → 4層 |
| 半地下有無 | 世田谷区 → 半地下無 / else → 半地下有 |
| EV有無 | 5層未満 → EV無 / 5層以上 → EV有 |
| 壁率 | 接道 < 6m → 高い / < 7m → やや高い / else → 標準的 |
| 設備率 | 建築面積 < 60㎡ → 高い / < 80㎡ → やや高い / else → 標準的 |
| グレード | デフォルト「やや高い」 |
| 地盤評価 | 柱状図あり → Phase 2判定 / なし → 地盤評価テーブル参照 |

### 3.3 データ確認依頼

抽出データをユーザーに提示し、確認を依頼：

```
【抽出データ確認】
- 土地価格: 6,980万円
- 土地所在: 板橋区
- 有効宅地面積: 109.40㎡
- 前面道路幅員: 7.5m
- ...

上記データに誤りがあれば、修正をお知らせください。
```

### 3.4 不足データの補完

取得できなかった項目についてユーザーに入力を依頼。

## Phase 4: 計算実行

### 4.1 Python計算モジュール呼び出し

全入力データが揃った時点で、`python/main.py`の`run_calculation()`を呼び出し：

```python
from python.main import run_calculation

result = run_calculation({
    "土地価格": 6980,
    "土地所在": "板橋区",
    "有効宅地面積": "109.40",
    "前面道路幅員": "7.5",
    "搬入経路": "規制無",
    "道路種別": "公道",
    "接道長さ": "8.7",
    "古家構造": "無し",
    "解体面積": "0",
    "実効建蔽率": "70",
    "用途地域": "第1種住居地域",
    "最大容積率": "200",
    "住宅種別": "共同住宅",
    "建物層数": 4,
    "半地下有無": "半地下有",
    "EV有無": "EV無",
    "壁率": "標準的",
    "設備率": "やや高い",
    "グレード": "やや高い",
    "地盤評価": "中間地盤"
})
```

### 4.2 計算結果の取得

`result`には以下が含まれる：

- 施工条件係数、建物形状係数
- 建築面積、施工面積
- 基礎種別、基礎単価、山留工法、山留単価
- 解体費用、基礎費用、山留費用、地盤費用
- 建物価格、PJ総額
- 貸床面積、貸床単価、年間売上
- 表面利回、目標利回

### 4.3 計算結果のバリデーション ★必須★

**計算結果を提示する前に、入力値がビジネスルールに沿っているか必ず検証する。**

#### チェックリスト

| 項目 | ビジネスルール | 検証内容 |
|------|---------------|----------|
| 実効建蔽率 | マイソク建蔽率+10%（耐火建築物緩和） | マイソク記載値に+10%しているか？ |
| 実効建蔽率上限 | ≦70% | 角地緩和等で70%を超えていないか？ |
| 最大容積率 | 基準容積率による制限 | 前面道路幅員×0.4（住居系）を考慮しているか？ |
| 住宅種別 | 接道長さ<4m→長屋 | 接道条件から正しく判定しているか？ |
| 半地下有無 | 世田谷区→半地下無 | 区の条例を考慮しているか？ |
| 建物層数 | 長屋→3層、共同住宅→4層 | 住宅種別と整合しているか？ |

#### 検証手順

1. **入力値の再確認**
   - `ビジネスルール一覧.json`の「取得ロジック_簡易」と照合
   - 「耐火建築物緩和+10%」と「基準容積率による制限」の見落としに注意

2. **乖離発見時の対応**
   - Phase 3に戻り、入力値を修正
   - 修正後、Phase 4.1から再実行
   - 修正理由をユーザーに説明

3. **バリデーション完了の明示**
   ```
   【バリデーション完了】
   ✓ 実効建蔽率: マイソク60% + 耐火緩和10% = 70%
   ✓ 最大容積率: 200%（道路幅員7.5m×0.4=300%、指定200%を採用）
   ✓ 住宅種別: 共同住宅（接道8.7m≧4m）
   ✓ 半地下有無: 半地下有（板橋区）
   ```

#### 過去の見落とし事例

- **実効建蔽率の耐火緩和見落とし**（2026-01-10）
  - マイソク記載の建蔽率60%をそのまま使用
  - 正しくは耐火建築物緩和+10%で70%
  - ユーザー指摘で発覚、再計算が必要になった

## Phase 5: 結果提示

### 5.1 クイックサマリー

対話スレッドに表面利回りを素早く確認できる形式で表示：

```
土地代金：69,800,000円
解体費用：0円
地盤費用：5,360,000円
施工面積：306.32㎡
施工単価：520,000円/㎡
工事代金：164,650,000円
建設経費：8,232,500円
ＰＪ総額：242,682,500円
貸床面積：274.32㎡
貸床単価：4,400円/㎡
年間収入：14,484,096円
表面利回：5.97%
```

### 5.2 詳細目論見書（アーティファクト）

Markdown形式で6セクション構成の目論見書を生成：

1. **プロジェクト概要**: 所在地、敷地面積、用途地域、建ぺい率/容積率
2. **建物計画**: 建物階数、延床面積、貸床面積、戸数、基礎種別
3. **コスト見積**: 土地代金、工事代金内訳、建設経費、PJ総額
4. **収益予測**: 貸床単価、年間収入、表面利回
5. **採算性判断**: 目標利回との比較、投資判断
6. **懸念事項**: 建設リスク、法規制注意点、地盤特記事項

### 5.3 懸念点の共有

マイソク・柱状図から得られた建設上の懸念点を箇条書きで共有：

```
【懸念事項】
- 前面道路が私道のため、通行承諾の確認が必要
- 高度地区による斜線制限で階数制限の可能性あり
- 地下水位が高い場合、山留工法の再検討が必要
```

## Phase 6: 修正対応

### 6.1 修正依頼への対応

ユーザーからデータ修正依頼があった場合：

1. 修正を受け入れ
2. Python計算モジュールを再実行
3. 結果を再表示

### 6.2 再計算のトリガー

以下の変更があった場合は再計算が必要：

- 入力データの変更（土地価格、面積、階数など）
- 地盤評価・基礎種別の変更
- 施工条件の変更

## Reference Files

### 単価テーブル

| ファイル | 用途 |
|---------|------|
| 建築単価テーブル.json | 施工面積・半地下有無による建築単価 |
| 基礎単価テーブル.json | 基礎種別ごとの単価（万円/㎡） |
| 山留単価テーブル.json | 山留工法・基礎種別・半地下有無による単価 |
| 解体単価テーブル.json | 古家構造ごとの解体単価 |
| 貸床単価テーブル.json | エリア別の貸床単価・目標利回 |

### 判定ロジック

| ファイル | 用途 |
|---------|------|
| 施工条件テーブル.json | 道路幅員・搬入経路等による係数 |
| 建物形状テーブル.json | 壁率・設備率・グレードによる係数 |
| 基礎種別テーブル.json | 地盤評価・階数による基礎種別決定 |
| 山留工法テーブル.json | 地盤評価による山留工法決定 |
| 地盤評価テーブル.json | 土地所在による地盤評価デフォルト値 |

### ナレッジ

| ファイル | 用途 |
|---------|------|
| 250712_企画の勘所.txt | 企画段階のノウハウ |
| 250712_設計の勘所.txt | 設計段階のノウハウ |

## 法規制確認（Web検索）

判断に迷う場合、以下のsite:指定検索を実施：

```
site:kijunhou.com [建築法規上のトピック]
site:jourei.jyunpo.com [区名] 住戸 戸数
site:jourei.jyunpo.com [区名] 建築基準法
site:jourei.jyunpo.com [区名] 消防法
```

---

*Last Updated: 2026-01-10*
*Maintained by: Weave @ めぐる組*
